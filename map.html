<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        .leaflet-marker-icon {
            border-radius: 50%;
            border: 2px solid black;
            background: transparent;
        }
        .leaflet-popup-content {
            width: 150px;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f9f9f9;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            font-size: 14px;
        }
        #controls h3 {
            margin-top: 0;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        #controls ul {
            list-style: none;
            padding: 0;
        }
        #controls li {
            margin-bottom: 8px;
        }
        #controls strong {
            display: inline-block;
            width: 150px;
            font-weight: bold;
            color: #555;
        }
        #controls li:last-child {
            margin-bottom: 0;
        }
        .user-position-icon,
        .additional-icon {
            font-size: 24px;
            color: black;
            background: transparent;
        }
        .user-position-ring {
            stroke: #FF5722;
            stroke-width: 2;
            stroke-dasharray: 4;
            fill: none;
        }
        .circle {
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black; /* Icon colour */
            background-color: white;
            font-size: 24px;
            line-height: 1;
            border: none;
        }
        .circle.red { background-color: white; }
        .circle.blue { background-color: white; }
        .circle.green { background-color: white; }
        .circle.purple { background-color: white; }
        #map-mode-toggle {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        #map-mode-toggle label {
            margin-right: 10px;
        }
        #map-mode-toggle select {
            padding: 5px;
        }
        #map-actions {
            margin-top: 10px;
        }
        #map-actions button {
            padding: 8px 12px;
            font-size: 14px;
            margin-right: 10px;
            cursor: pointer;
        }
        #map-actions button.active {
            background-color: #007bff;
            color: white;
        }
        #center-toggle {
            margin-top: 10px;
        }
        #center-toggle button {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        #center-toggle button.active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <h3>Map Controls</h3>
        <ul>
            <li><strong>Click:</strong> Set/Delete Lines and Points</li>
            <li><strong>Drag:</strong> Pan Map</li>
            <li><strong>Scroll Wheel:</strong> Zoom In/Out</li>
            <li><strong>Arrow Keys:</strong> Move Plane</li>
        </ul>
        <div id="map-actions">
            <button id="add-point" class="active">Add Point</button>
            <button id="draw-line">Draw Line</button>
            <button id="remove-point">Remove Point</button>
        </div>
        <div id="map-mode-toggle">
            <label for="map-mode">Map Type:</label>
            <select id="map-mode">
                <option value="osm">OpenStreetMap</option>
                <option value="stamen-terrain">Stamen Terrain</option>
                <option value="carto-light">Carto Light</option>
            </select>
        </div>
        <div id="center-toggle">
            <button id="toggle-center">Center on Plane</button>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const map = L.map('map').setView([-37.814, 144.963], 13); // Melbourne

        let currentBaseLayer;

        function updateTileLayer(layerType) {
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }

            const tileLayers = {
                osm: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                'stamen-terrain': 'https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png?api_key=5a677b5d-7b56-450a-b358-2d5a5a8af829',
                'carto-light': 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
            };

            currentBaseLayer = L.tileLayer(tileLayers[layerType], {
                attribution: layerType === 'osm'
                    ? '© OpenStreetMap contributors'
                    : '© OpenStreetMap contributors, © Stamen Design, © CartoDB'
            }).addTo(map);
        }

        updateTileLayer('osm'); // Set default layer to OpenStreetMap

        const points = [];
        let lines = [];
        let mode = 'add-point'; // Default mode
        let autoCenterOnPlane = false; // Toggle for auto-centering

        const markersLayer = L.layerGroup().addTo(map);
        const linesLayer = L.layerGroup().addTo(map);

        // Define user position icon with Material Icons
        const userIcon = L.divIcon({
            className: 'user-position-icon',
            html: '<i class="material-icons">flight</i>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Define additional icons
        const icons = {
            plane: L.divIcon({
                className: 'user-position-icon',
                html: '<i class="material-icons">flight</i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            }),
            star: L.divIcon({
                className: 'additional-icon',
                html: '<i class="material-icons">star</i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            }),
            heart: L.divIcon({
                className: 'additional-icon',
                html: '<i class="material-icons">favorite</i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            }),
            check: L.divIcon({
                className: 'additional-icon',
                html: '<i class="material-icons">check</i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            }),
            alert: L.divIcon({
                className: 'additional-icon',
                html: '<i class="material-icons">warning</i>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        };

        let userMarker;
        let userRing;
        let userSmallRing;

        // Function to update user position marker and rings
        function updateUserPosition(latlng) {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            if (userRing) {
                map.removeLayer(userRing);
            }
            if (userSmallRing) {
                map.removeLayer(userSmallRing);
            }

            userRing = L.circle(latlng, {
                radius: 3000, // Radius of the large ring in metres
                color: '#FF5722', // Orange
                weight: 2,
                fillOpacity: 0
            }).addTo(map);

            userSmallRing = L.circle(latlng, {
                radius: 1000, // Radius of the small ring in metres
                color: '#FF5722', // Orange
                weight: 2,
                fillOpacity: 0,
                strokeDasharray: '2, 6' // Smaller dotted border attempt - no idea why this is solid
            }).addTo(map);

            userMarker = L.marker(latlng, { icon: icons.plane }).addTo(map);

            if (autoCenterOnPlane) {
                map.setView(latlng, map.getZoom());
            }
        }

        const userPosition = { lat: -37.814, lng: 144.963 }; // Central Melbourne
        updateUserPosition(userPosition);

        const additionalPositions = [
            { lat: -37.805, lng: 144.963, icon: icons.star },
            { lat: -37.804, lng: 144.913, icon: icons.heart },
            { lat: -37.824, lng: 144.933, icon: icons.check },
            { lat: -37.844, lng: 144.953, icon: icons.alert }
        ];

        additionalPositions.forEach(pos => {
            L.marker([pos.lat, pos.lng], { icon: pos.icon }).addTo(map);

            L.circle([pos.lat, pos.lng], {
                radius: 3000,
                color: pos.icon.options.html.includes('red') ? '#FF0000' :
                pos.icon.options.html.includes('blue') ? '#0000FF' :
                pos.icon.options.html.includes('green') ? '#00FF00' :
                '#800080',
                weight: 2,
                opacity: 0.5,
                fillOpacity: 0
            }).addTo(map);
        });

        function drawPoints() {
            markersLayer.clearLayers();
            points.forEach((point) => {
                L.marker([point.lat, point.lon], { draggable: true })
                    .addTo(markersLayer);
            });
        }

        function drawLines() {
            linesLayer.clearLayers();
            lines.forEach(line => {
                if (line.start && line.end) {
                    L.polyline([[line.start.lat, line.start.lon], [line.end.lat, line.end.lon]], {
                        color: 'black',
                        weight: 2
                    }).addTo(linesLayer);
                }
            });
        }

        function removePoint(latlng) {
            // Define the tolerance for point removal
            const tolerance = 0.01; // Adjust this value as needed

            // Find index of the point to remove based on distance
            const index = points.findIndex(point => {
                return Math.hypot(point.lat - latlng.lat, point.lon - latlng.lng) < tolerance;
            });

            if (index !== -1) {
                // Remove the point
                points.splice(index, 1);
                // Remove associated lines
                lines = lines.filter(line => line.start !== points[index] && line.end !== points[index]);

                // Redraw points and lines
                drawPoints();
                drawLines();

                /* alert("Point removed successfully!"); */
            } else {
                alert("No point found or point is too far away."); // Feedback
            }
        }


        let firstPoint = null;

        map.on('click', function(event) {
            const coords = event.latlng;
            if (!coords) return;

            if (mode === 'add-point') {
                const pointCoords = {
                    lat: coords.lat,
                    lon: coords.lng
                };
                points.push(pointCoords);
                drawPoints();
            } else if (mode === 'draw-line') {
                if (firstPoint === null) {
                    firstPoint = { lat: coords.lat, lon: coords.lng };
                } else {
                    const secondPoint = { lat: coords.lat, lon: coords.lng };
                    lines.push({ start: firstPoint, end: secondPoint });
                    drawLines();
                    firstPoint = null; // Reset for the next line
                }
            } else if (mode === 'remove-point') {
                removePoint(coords);
            }
        });

        function moveUserPosition(deltaLat, deltaLng) {
            const newLat = userMarker.getLatLng().lat + deltaLat;
            const newLng = userMarker.getLatLng().lng + deltaLng;
            const newLatLng = L.latLng(newLat, newLng);

            updateUserPosition(newLatLng);
        }

        document.addEventListener('keydown', function(event) {
            const step = 0.001; // Adjust step size as needed

            switch(event.key) {
                case 'ArrowUp':
                    moveUserPosition(step, 0);
                    break;
                case 'ArrowDown':
                    moveUserPosition(-step, 0);
                    break;
                case 'ArrowLeft':
                    moveUserPosition(0, -step);
                    break;
                case 'ArrowRight':
                    moveUserPosition(0, step);
                    break;
            }
        });

        document.getElementById('add-point').addEventListener('click', function() {
            mode = 'add-point';
            this.classList.add('active');
            document.getElementById('draw-line').classList.remove('active');
            document.getElementById('remove-point').classList.remove('active');
            firstPoint = null; // Reset line drawing mode
        });

        document.getElementById('draw-line').addEventListener('click', function() {
            mode = 'draw-line';
            this.classList.add('active');
            document.getElementById('add-point').classList.remove('active');
            document.getElementById('remove-point').classList.remove('active');
            firstPoint = null; // Reset line drawing mode
        });

        document.getElementById('remove-point').addEventListener('click', function() {
            mode = 'remove-point';
            this.classList.add('active');
            document.getElementById('add-point').classList.remove('active');
            document.getElementById('draw-line').classList.remove('active');
            firstPoint = null; // Reset line drawing mode
        });

        document.getElementById('map-mode').addEventListener('change', function() {
            updateTileLayer(this.value);
        });

        document.getElementById('toggle-center').addEventListener('click', function() {
            autoCenterOnPlane = !autoCenterOnPlane;
            this.classList.toggle('active', autoCenterOnPlane);
        });
    });
    </script>
</body>
</html>
